name: "baseos-gl-conan"
title: "BaseOS Conan Builder Docker Image"
description: |
  Contains: GCC and all base OS libraries
packages: []
implicit_packages:
  - cuda
  - optix
  - glvnd
  - ccache
  - dts
  - sonar
  - cmake
  - conan
  - yq
docker_from: ${ASWF_BASEOS_IMAGE}:${ASWF_CUDA_VERSION}-runtime-${ASWF_BASEOS_DISTRO}
docker_package_version: $CI_COMMON_VERSION
docker_commands: |
  COPY ../scripts/common/install_cudadevel.sh /tmp/

  RUN --mount=type=cache,sharing=private,target=/var/cache/yum \
      /tmp/install_cudadevel.sh

  COPY ../scripts/common/install_yumpackages.sh /tmp/

  RUN --mount=type=cache,sharing=private,target=/var/cache/yum \
      /tmp/install_yumpackages.sh

  COPY scripts/common/install_opengl.sh /tmp/

  ARG ASWF_BASEOS_DISTRO
  ENV ASWF_BASEOS_DISTRO=${ASWF_BASEOS_DISTRO}
  RUN /tmp/install_opengl.sh

  ENV NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
  ENV NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:+$NVIDIA_DRIVER_CAPABILITIES,}graphics
  ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig

  COPY scripts/common/install_optix.sh /tmp/

  RUN /tmp/install_optix.sh

  COPY scripts/common/install_pippackages.sh /tmp/

  RUN --mount=type=cache,sharing=private,target=/root/.cache/pip \
      /tmp/install_pippackages.sh

  COPY ../scripts/common/install_dev_ccache.sh \
       ../scripts/common/before_build.sh \
       ../scripts/common/copy_new_files.sh \
       ../scripts/common/install_dev_cmake.sh \
       /tmp/

  ENV DOWNLOADS_DIR=/tmp/downloads \
      CCACHE_DIR=/tmp/ccache \
      ASWF_INSTALL_PREFIX=/usr/local \
      LD_LIBRARY_PATH=/usr/local/lib:/opt/rh/${ASWF_DTS_PREFIX}-${ASWF_DTS_VERSION}/root/usr/lib64:/opt/rh/${ASWF_DTS_PREFIX}-${ASWF_DTS_VERSION}/root/usr/lib:${LD_LIBRARY_PATH} \
      PATH=/opt/aswfbuilder/bin:/usr/local/bin:/opt/rh/${ASWF_DTS_PREFIX}-${ASWF_DTS_VERSION}/root/usr/bin:/opt/app-root/src/bin:/opt/rh/${ASWF_DTS_PREFIX}-${ASWF_DTS_VERSION}/root/usr/bin/:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin

  RUN --mount=type=cache,sharing=private,target=/tmp/downloads \
      /tmp/install_dev_cmake.sh && \
      /tmp/install_dev_ccache.sh

  COPY scripts/common/install_yq.sh /tmp/

  RUN /tmp/install_yq.sh

  # Merge the previously separate ci-baseos-gl-os and ci-baseos-gl-conan stages:
  # we are unlikely to want to iterate on Conan versions separately from the base image,
  # and we want to make sure that ci-conan-package-builder always pulls a pre-built
  # ci-baseos-gl-conan from Docker Hub rather than rebuilding it locally.

  ARG ASWF_CONAN_VERSION
  ARG ASWF_CONAN_PYTHON_VERSION

  ENV ASWF_CONAN_ROOT=/opt/conan

  COPY ../scripts/common/install_conan.sh /tmp/

  RUN --mount=type=cache,sharing=private,target=/tmp/downloads \
      /tmp/install_conan.sh
