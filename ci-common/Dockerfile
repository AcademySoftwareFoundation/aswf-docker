# Copyright (c) Contributors to the aswf-docker Project. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# !!! This file is automatically generated from a template and the `data.yaml` file in the same folder !!!

ARG ASWF_ORG
ARG ASWF_PKG_ORG
ARG CI_COMMON_VERSION
ARG CLANG_MAJOR_VERSION

ARG CLANG_VERSION
ARG NINJA_VERSION
ARG CUDA_VERSION
ARG CCACHE_VERSION
ARG DTS_VERSION
ARG SONAR_VERSION


FROM ${ASWF_PKG_ORG}/ci-package-clang:$CI_COMMON_VERSION-$CLANG_VERSION as ci-package-clang
FROM ${ASWF_PKG_ORG}/ci-package-ninja:$CI_COMMON_VERSION-$NINJA_VERSION as ci-package-ninja
FROM nvidia/cudagl:${CUDA_VERSION}-devel-centos7 as ci-common


ARG ASWF_ORG
ARG ASWF_VERSION

ARG CLANG_VERSION
ARG NINJA_VERSION
ARG CUDA_VERSION
ARG CCACHE_VERSION
ARG DTS_VERSION
ARG SONAR_VERSION


LABEL org.opencontainers.image.name="$ASWF_ORG/ci-common"
LABEL org.opencontainers.image.title="Common CI Docker Image"
LABEL org.opencontainers.image.description="Contains: gcc, clang, ninja, ccache and all base OS libraries\
"
LABEL org.opencontainers.image.url="http://aswf.io/"
LABEL org.opencontainers.image.source="https://github.com/AcademySoftwareFoundation/aswf-docker/blob/master/ci-common/Dockerfile"
LABEL org.opencontainers.image.vendor="AcademySoftwareFoundation"
LABEL org.opencontainers.image.authors="Built by aswf.io CI Working Group"
LABEL org.opencontainers.image.version="${ASWF_VERSION}"

LABEL com.vfxplatform.version="${VFXPLATFORM_VERSION}"

LABEL io.aswf.docker.versions.clang="$CLANG_VERSION"
LABEL io.aswf.docker.versions.ninja="$NINJA_VERSION"
LABEL io.aswf.docker.versions.cuda="$CUDA_VERSION"
LABEL io.aswf.docker.versions.ccache="$CCACHE_VERSION"
LABEL io.aswf.docker.versions.dts="$DTS_VERSION"
LABEL io.aswf.docker.versions.sonar="$SONAR_VERSION"


ENV ASWF_ORG=${ASWF_ORG}
ENV ASWF_VERSION=${ASWF_VERSION}
ENV CLANG_VERSION=$CLANG_VERSION
ENV NINJA_VERSION=$NINJA_VERSION
ENV CUDA_VERSION=$CUDA_VERSION
ENV CCACHE_VERSION=$CCACHE_VERSION
ENV DTS_VERSION=$DTS_VERSION
ENV SONAR_VERSION=$SONAR_VERSION


COPY --from=ci-package-clang /. /usr/local/
COPY --from=ci-package-ninja /. /usr/local/
COPY ci-common/README.md ci-common/image.yaml /usr/local/aswf/

USER root

COPY scripts/common/install_yumpackages.sh \
    /tmp/

RUN /tmp/install_yumpackages.sh

RUN mkdir /opt/aswf
WORKDIR /opt/aswf

ENV LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib64:/opt/rh/httpd24/root/usr/lib64:/opt/rh/devtoolset-${DTS_VERSION}/root/usr/lib64:/opt/rh/devtoolset-${DTS_VERSION}/root/usr/lib:${LD_LIBRARY_PATH} \
    PATH=/opt/rh/rh-git218/root/usr/bin:/usr/local/bin:/opt/rh/devtoolset-${DTS_VERSION}/root/usr/bin:/opt/app-root/src/bin:/opt/rh/devtoolset-${DTS_VERSION}/root/usr/bin/:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin \
    PERL5LIB=/opt/rh/rh-git218/root/usr/share/perl5/vendor_perl \
    MANPATH=/opt/rh/rh-git218/root/usr/share/man

COPY scripts/common/install_sonar.sh \
    scripts/common/install_ccache.sh \
    scripts/common/install_dev_cmake.sh \
    /tmp/

RUN export DOWNLOADS_DIR=/tmp/downloads && \
  mkdir /tmp/downloads && \
  /tmp/install_sonar.sh && \
  export PATH=${PATH}:/opt/aswfbuilder/bin && \
  /tmp/install_dev_cmake.sh && \
  /tmp/install_ccache.sh && \
  rm -rf /tmp/downloads && \
  rm -rf /opt/aswfbuilder

COPY scripts/common/setup_aswfuser.sh /tmp
RUN /tmp/setup_aswfuser.sh


